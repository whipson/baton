---
title: "Quick Start"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{maestro-quick-start}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(DiagrammeR)
```


`maestro` is a framework that helps orchestrate and schedule data pipelines. The framework consists of four elements:

1) creating a project
2) create pipeline script(s)
3) create orchestration script
4) schedule the orchestration script

<br>

The following sections outline examples of each of the four elements. 

<br>

```{r overview, fig.width = 10, fig.height = 1, echo = FALSE}
DiagrammeR::mermaid("
                    graph LR
                      A[Create Project]-->B[Create Pipeline]
                      B[Create Pipeline]-->C[Create Orchestrator Script]
                      C[Create Orchestrator Script]-->D[Schedule Orchestrator Script]
                    ")
```


## Create Project
A `maestro` project requires, at a minimum, a root project folder, an orchestrator script, a pipelines folder, and pipeline script(s) in the pipelines folder.

```{r basic-setup, fig.width = 10, fig.height = 3, echo = FALSE}
DiagrammeR::mermaid("
                    graph TD
                      A[Project folder]-->B[Orchestrator script]
                      A[Project folder]-->C[Pipelines folder]
                      C[Pipelines folder]-->D[Pipeline script 1]
                      C[Pipelines folder]-->E[Pipeline script 2]
                    ")
```



### Sample Project
In this section we will create a sample project to be the home for our orchestration script and pipelines. Our sample project will have the following elements using these names:

- Project folder `maestro_project`
- Orchestrator script `orchestrator.R`
- Pipelines folder `pipelines`
  - Pipeline script 1 `pipe_mtcars_hourly.R`
  - Pipeline script 2 `pipe_iris_daily.R`

<br>

There are a few approaches for creating a new R project. This example is using RStudio IDE:

- Manually approach
  - From the file tab
  - Using the R project dropdown (upper right)
- Code approach
  - With the `usethis` package

<br>


#### Manual Approach
From the `File` table (typically the upper left)

- Choose `New Project...`
- In the *New Project Wizard* window `New Directory`
- Then `New Project`
- In the *Create New Project* window enter the elements that work for your project
  - *Directory name* (i.e. `maestro_proejct`)
  - *Create project as subdirectory of* (i.e. `~/maestro_project` on Mac or Linux, or `C:\maestro_project` on Windows)
  - *Create a git repository* (optional)
  - *Use renv with this project* (optional)
  - *Open in new session* (optional)
- Then click the *Create Project* button

<br>


#### Code Approach
For a code based approach, the following can be used to create a new R project

```{r create-project-code, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
# Code approach for creating a R project with a pipelines folder
# Create new R project using the usethis R package
library(usethis)
create_project("~/maestro_project")

# Set working director to new R project
setwd("~/maestro_project")

# Add pipelines folder in new R project
dir.create("pipelines")
```

<br>


## Create Pipelines
Creating a pipeline

- Using the `create_pipeline` function
  - pipe_name (required)
  - pipeline_dir (optional - default to `pipelines`)
  - frequency (required)
  - interval (required)
  - start_time (required)
  - tz (required)

<br>

| **Parameter** | **Description** | **Example** |
| :---: | :---------- | :----- |
| pipe_name | The name to be used for the pipeline script | `pipeline1` |
| pipeline_dir | Folder where to save the pipeline script | `pipelines` |
| frequency | How often the pipeline should run (minute, hour, day, week, month, quarter, year) | `day` |
| interval | Unit of frequency between run of pipeline | `1` |
| start_time | Start time of the pipeline schedule based on a datetime format (yyyy-mm-dd hh:mm:ss) | `2024-05-17 15:00:00` |
| tz | Timezone that pipeline will be scheduled in, based on timezones from the `OlsonNames` R function | `America/Halifax` |

<br>

The following uses the examples from the above table within the `create_pipeline` function

```{r example-pipe, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
create_pipeline(
  pipe_name = "pipeline1",
  pipeline_dir = "pipelines",
  frequency = "day",
  interval = 1,
  start_time = "2024-05-17 15:00:00",
  tz = "America/Halifax"
)
```

<br>

Which creates a R pipeline script with the following:

```{r example-output, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
#' pipeline1 maestro pipeline
#'
#' @maestroFrequency day
#' @maestroInterval 1
#' @maestroStartTime 2024-05-17 15:00:00
#' @maestroTz America/Halifax

pipeline1 <- function() {

  # Pipeline code
}
```

<br>

The output from `create_pipeline` is the structure of a `maestro` pipeline with a section to write the code that is to be executed. A `maestro` pipeline is essentially considered a named function without any parameters. The code to be executed is written within the curly braces `{}` of the function.

The next two sections will illustrate repeatable examples of `maestro` pipelines using the `mtcars` and `iris` datasets.

<br>


### Hourly Pipeline
For this pipeline suppose we wanted to calculate descriptive statistics for a sample of rows in the `mtcars` dataset and save a RDS file to an output folder. To achieve this we would first create a pipeline file using the `create_pipeline` function from `maestro` and then add the pipeline logic to the pipeline script within the named function curly braces.

<br>

```{r hourly-pipe, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
create_pipeline(
  pipe_name = "pipe_mtcars_hourly",
  pipeline_dir = "pipelines",
  frequency = "hour",
  interval = 3,
  start_time = "2024-05-17 15:00:00",
  tz = "America/Halifax"
)
```

<br>

Which creates a R pipeline script with the following:

```{r mtcars-pipe, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
#' pipe_mtcars_hourly maestro pipeline
#'
#' @maestroFrequency hour
#' @maestroInterval 3
#' @maestroStartTime 2024-05-17 15:00:00
#' @maestroTz America/Halifax

pipe_mtcars_hourly <- function() {

  library(dplyr)
  
  
  
  output_path <- "output/"
  base_name <- "mtcars_stats_"
  timestamp <- as.integer(Sys.time())

  mtcars |>
    slice_sample(n = 10) |>
    summarize(min_disp = min(disp, na.rm = TRUE),
              mean_dis = mean(disp, na.rm = TRUE),
              max_disp = max(disp, na.rm = TRUE),
              sd_disp = sd(disp, na.rm = TRUE)) |>
    saveRDS(paste0(output_path, base_name, timestamp, ".RDS"))
}
```


<br>


### Daily Pipeline
For this pipeline suppose we wanted to create a scatter plot for a sample of rows in the `iris` dataset and save a png file to an output folder. To achieve this we would first create a pipeline file using the `create_pipeline` function from `maestro` and then add the pipeline logic to the pipeline script within the named function curly braces.

<br>

```{r daily-pipe, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
create_pipeline(
  pipe_name = "pipe_iris_daily",
  pipeline_dir = "pipelines",
  frequency = "day",
  interval = 1,
  start_time = "2024-05-17 08:10:00",
  tz = "America/Halifax"
)
```

<br>

Which creates a R pipeline script with the following:

```{r iris-pipe, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
#' pipe_iris_daily maestro pipeline
#'
#' @maestroFrequency day
#' @maestroInterval 1
#' @maestroStartTime 2024-05-17 08:10:00
#' @maestroTz America/Halifax

pipe_iris_daily <- function() {
  
  library(dplyr)
  library(ggplot2)
  
  base_name <- "iris_plot_"
  timestamp <- as.integer(Sys.time())
  
  iris |>
    slice_sample(prop = 0.3) |>
    ggplot() +
    aes(x = Sepal.Length, y = Sepal.Width, colour = Species) +
    geom_point(shape = "circle", size = 1.5) +
    scale_color_hue(direction = 1) +
    labs(x = "Sepal Length", y = "Sepal Width") +
    theme_minimal()
  
  ggsave(
    filename = paste0(base_name, timestamp, ".png"),
    device = "png",
    path = "~/plots/"
    )
}
```



## Create Orchestrator Script
In this example we selected R script as the format for the orchestrator script. Quatro documents can also be used for orchestrator scripts, which is recommended when using products like Posit Connect for scheduling.

Creating an orchestration script consists of two function calls within the script, `build_schedule` and `run_schedule`. The `build_schedule` function generates a data frame of pipelines to run. The data frame is used with the `run_schedule` function, which consists of the following parameters:

  - schedule (required)
  - orch_interval (required - has default)
  - orch_frequency (required - has default)
  - check_datetime (required - has default)
  - resources (required - has default)
  - run_all (required - has default)
  - n_show_not_run (required - has default)
  - cores (required - has default)
  - quite (required - has default)

<br>

| **Parameter** | **Description** | **Default** | **Example** |
| :---: | :---------- | :----- | :----- |
| schedule | A table of scheduled pipelines | N/A | `schedule_table` |
| orch_interval | A numeric value representing how often the orchestration runs | `1` | `1` |
| orch_frequency | How often the orchestration should run (minute, hour, day, week, month, quarter, year) | `day` | `hour` |
| check_datetime | datetime used to check against the pipeline start datetime | `lubridate::now(tzone = "UTC")` | `lubridate::now(tzone = "UTC")` |
| resources | Named list of shared resources made available to pipelines as needed | `list()` | `list()` |
| run_all | Run all pipelines regardless of the schedule | `FALSE` | `FALSE` |
| n_show_not_run | show number of pipelines that did not run and when they will run next | `5` | `5` |
| cores | Number of cpu cores to run if running in parallel | `1` | `1` |
| quite | Print metrics to the console | `FALSE` | `FALSE` |

<br>

In this example we set the orchestration script to operate more often than our smallest time period of our pipelines. 

<br>

```{r orch, echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE}
library(maestro)

schedule_table <- build_schedule(pipeline_dir = "pipelines")

run_schedule(
  schedule_table,
  orch_interval = 1,
  orch_frequency = "hour"
  )
```

<br>


## Schedule Orchestrator Script
Scheduling the orchestration script occurs out of `maestro`. There are different options for scheduling the orchestration script, depending on where the orchestration script is executed (i.e. local or cloud). 

A best practice for scheduling the orchestration script is to set it to run less than equal to pipeline with the smallest timeframe (frequency and interval). With the examples provided above, the `pipe_mtcars_hourly` pipeline has the smallest timeframe with `maestroFrequency` of an hour and a `maestroInterval` of 3. The orchestration script has a hour `orch_frequency` and an `orch_interval` equal to 1. With this it would be advised to schedule the orchestration script to run every hour.

There are different options for scheduling the script, such as the `cronr` and `taskscheduleR` packages, within Posit Connect, or the various cloud services.




